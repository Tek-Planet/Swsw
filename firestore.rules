rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    //================================================================================
    // GENERAL-PURPOSE RULES
    //================================================================================

    // Deny all reads and writes by default.
    match /{document=**} {
      allow read, write: if false;
    }

    // Helper function to check if a user is authenticated.
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to check if the user is an admin.
    function isAdmin() {
      return request.auth.token.admin == true;
    }

    // Helper function to check if a user is an event admin for a specific event.
    function isEventAdmin(eventId) {
      return request.auth.token.eventAdmin == true && eventId in request.auth.token.eventIds;
    }

    // Helper function to check ownership of a document.
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Helper function to check if a user is a member of a group.
    function isGroupMember(groupId) {
      return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
    }


    //================================================================================
    // USER DATA
    //================================================================================

    match /users/{userId} {
        // Public user data (e.g., profiles) can be read by anyone.
        allow read: if true;

        // Users can only create and modify their own documents.
        allow create, update, delete: if isOwner(userId);

        // Only the user can access their private subcollections.
        match /private/{docId} {
          allow read, write: if isOwner(userId);
        }
        
        // Anyone can view a user's connections. Only the user can edit them.
        match /connections/{connectionId} {
          allow read: if true;
          allow write: if isOwner(userId);
        }

        // Users can manage their own FCM tokens for push notifications.
        match /fcmTokens/{tokenId} {
            allow read, write, delete: if isOwner(userId);
        }
    }

    //================================================================================
    // GROUPS (BUDS)
    //================================================================================

    match /groups/{groupId} {
      // Users can create a group if they are signed in and are a member of the group.
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.members;

      // Users can read group data if they are a member of the group.
      allow read: if isSignedIn() && request.auth.uid in resource.data.members;

      // Users can update group data if they are a member of the group.
      allow update: if isSignedIn() && request.auth.uid in resource.data.members;

      // Only the creator of the group can delete it.
      allow delete: if isSignedIn() && resource.data.createdBy == request.auth.uid;

      // Rules for the expenses subcollection
      match /expenses/{expenseId} {
        // Allow full access if the user is a member of the group.
        allow read, write: if isGroupMember(groupId);
      }
    }

    //================================================================================
    // POLLS
    //================================================================================

    match /polls/{pollId} {
      // Allow read and update if the user is a member of the poll's group.
      allow read, update: if isSignedIn() &&
        request.auth.uid in get(/databases/$(database)/documents/groups/$(resource.data.groupId)).data.members;

      // Allow create if the user is a member of the poll's group.
      allow create: if isSignedIn() &&
        request.auth.uid in get(/databases/$(database)/documents/groups/$(request.resource.data.groupId)).data.members;

      // Allow delete if the user is the creator of the poll.
      allow delete: if isSignedIn() && resource.data.createdBy == request.auth.uid;
    }

    //================================================================================
    // EVENTS
    //================================================================================

    match /events/{eventId} {
          // Admins and event admins can read any event. Others can read published events or those they attend.
          allow read: if isAdmin() || isEventAdmin(eventId) || (resource.data.status == 'published') || (isSignedIn() && (request.auth.uid in resource.data.attendeeIds));
          
          // Admins and event admins can create, update, and delete any event.
          allow create, update, delete: if isAdmin() || isEventAdmin(eventId);
          
          // Rules for Event Subcollections

          match /survey/{surveyId} {
            // Admins have full access. Signed-in users can read.
            allow read: if isSignedIn();
            allow write: if isAdmin() || isEventAdmin(eventId);
          }

          match /ticketTiers/{tierId} {
            // Ticket tiers can be read by anyone.
            // Only admins or event admins can modify ticket tiers.
            allow read: if true;
            allow create, update, delete: if isAdmin() || isEventAdmin(eventId);
          }
          
          match /albums/{albumId} {
            // Explicitly grant 'list' for collection queries by signed-in users.
            allow get, create: if isSignedIn();
            allow list: if isSignedIn();
            allow update, delete: if isAdmin() || isEventAdmin(eventId);

            match /photos/{photoId} {
                // Explicitly grant 'list' for collection queries by signed-in users.
                allow get, create: if isSignedIn();
                allow list: if isSignedIn();
                allow update, delete: if isAdmin() || isEventAdmin(eventId);
            }
          }
    }
    
    //================================================================================
    // EVENT NOTIFICATIONS
    //================================================================================
    match /event_notifications/{notificationId} {
      // Any signed-in user can read notifications.
      allow read: if isSignedIn();

      // Admins or event admins can create notifications.
      allow create: if isAdmin() || isEventAdmin(request.resource.data.eventId);

      // Admins or event admins for the event can update or delete notifications.
      allow update: if isAdmin() || isEventAdmin(request.resource.data.eventId);
      allow delete: if isAdmin() || isEventAdmin(resource.data.eventId);
    }

    //================================================================================
    // ORDERS & TICKETS
    //================================================================================

    match /orders/{orderId} {
        // Users can get their own specific order. Admins and event admins can get any order.
        allow get: if isOwner(resource.data.userId) || isAdmin() || isEventAdmin(resource.data.eventId);

        // Users and event admins can query their orders. Your client-side query MUST filter.
        allow list: if isSignedIn() || isAdmin() || request.auth.token.eventAdmin == true;

        // Users can create their own orders.
        allow create: if isOwner(request.resource.data.userId);

        // Allow admins and event admins to update or delete orders.
        allow update, delete: if isAdmin() || isEventAdmin(resource.data.eventId);

        // Users can read tickets if they own the order. Admins and event admins can also read and write tickets.
        match /tickets/{ticketId} {
            allow read: if (isSignedIn() && get(/databases/$(database)/documents/orders/$(orderId)).data.userId == request.auth.uid) || isAdmin() || isEventAdmin(get(/databases/$(database)/documents/orders/$(orderId)).data.eventId);
            allow write: if isAdmin() || isEventAdmin(get(/databases/$(database)/documents/orders/$(orderId)).data.eventId);
        }
    }
    
    // Promo codes are read-only for clients, modifiable by admins.
    match /promoCodes/{codeId} {
        allow read: if isSignedIn();
        allow write: if isAdmin();
    }
    
    //================================================================================
    // EVENT GRIDS (SURVEY MATCHES)
    //================================================================================
    
    // Users can only read their own result grid.
    match /event_grids/{eventId}/grids/{userId} {
      allow read: if isOwner(userId);
      allow write: if false; // Protect from client-side writes
    }
    
    //================================================================================
    // EVENT SURVEY SUBMISSIONS
    //================================================================================
    
    // Users can create their own submission.
    // Admins can read any submission.
    match /event_surveys/{eventId}/submissions/{userId} {
      allow create: if isOwner(userId);
      allow read: if isOwner(userId) || isAdmin() || isEventAdmin(eventId);
    }
    
    //================================================================================
    // NOTIFICATIONS
    //================================================================================
    
    // Users can only manage their own notifications.
    match /notifications/{userId}/user_notifications/{notificationId} {
        allow read, write: if isOwner(userId);
    }

    //================================================================================
    // USER ROLES
    //================================================================================

    match /user_roles/{roleId} {
      // Admins can read all role assignments to manage them.
      // Other users cannot read these roles to prevent privilege escalation.
      allow read: if isAdmin();
      
      // Writes are handled by Cloud Functions, not direct client access.
      allow write: if false;
    }
  }
}

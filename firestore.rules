
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    //================================================================================
    // GENERAL-PURPOSE RULES
    //================================================================================

    // Deny all reads and writes by default.
    match /{document=**} {
      allow read, write: if false;
    }

    // Helper function to check if a user is authenticated.
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to check if the user is an admin.
    function isAdmin() {
      return request.auth.token.admin == true;
    }

    // Helper function to check ownership of a document.
    function isOwner(userId) {
      return request.auth.uid == userId;
    }


    //================================================================================
    // USER DATA
    //================================================================================

    match /users/{userId} {
        // Public user data (e.g., profiles) can be read by anyone.
        allow read: if true;

        // Users can only create and modify their own documents.
        allow create, update, delete: if isOwner(userId);

        // Only the user can access their private subcollections.
        match /private/{docId} {
          allow read, write: if isOwner(userId);
        }
        
        // Anyone can view a user's connections. Only the user can edit them.
        match /connections/{connectionId} {
          allow read: if true;
          allow write: if isOwner(userId);
        }
    }

    //================================================================================
    // EVENTS
    //================================================================================

    match /events/{eventId} {
          // Allow read if event is published OR user is an attendee.
          allow read: if (resource.data.status == 'published') || (isSignedIn() && (request.auth.uid in resource.data.attendeeIds));
          // Admins can create, update, and delete any event.
          allow create, update, delete: if isAdmin();
          
          // Any signed-in user to read survey questions for an event.
          match /survey/{surveyId} {
            allow read: if isSignedIn();
          }

          // Ticket tiers can be read by anyone.
          // Only admins can modify ticket tiers.
          match /ticketTiers/{tierId} {
            allow read: if true;
            allow create, update, delete: if isAdmin();
          }
          
          // Rules for Event Albums and Photos
          match /albums/{albumId} {
            allow read, create: if isSignedIn();

            match /photos/{photoId} {
                allow read, create: if isSignedIn();
            }
          }
    }

    //================================================================================
    // ORDERS & TICKETS
    //================================================================================

    match /orders/{orderId} {
        // Users can get their own specific order. Admins can get any order.
        allow get: if isOwner(resource.data.userId) || isAdmin();

        // Users can query for their own orders. Your client-side query MUST
        // include `.where('userId', '==', currentUser.uid)`.
        allow list: if isSignedIn() || isAdmin();

        // Users can create their own orders.
        allow create: if isOwner(request.resource.data.userId);

        // Allow admins to update or delete orders.
        allow update, delete: if isAdmin();

        // Users can read tickets if they own the order.
        match /tickets/{ticketId} {
            allow read: if isSignedIn() && get(/databases/$(database)/documents/orders/$(orderId)).data.userId == request.auth.uid;
            allow write: if isAdmin();
        }
    }
    
    // Promo codes are read-only for clients, modifiable by admins.
    match /promoCodes/{codeId} {
        allow read: if isSignedIn();
        allow write: if isAdmin();
    }
    
    //================================================================================
    // EVENT GRIDS (SURVEY MATCHES)
    //================================================================================
    
    // Users can only read their own result grid.
    match /event_grids/{eventId}/grids/{userId} {
      allow read: if isOwner(userId);
      allow write: if false; // Protect from client-side writes
    }
    
    //================================================================================
    // EVENT SURVEY SUBMISSIONS
    //================================================================================
    
    // Users can create their own submission.
    // Admins can read any submission.
    match /event_surveys/{eventId}/submissions/{userId} {
      allow create: if isOwner(userId);
      allow read: if isOwner(userId) || isAdmin();
    }
    
    //================================================================================
    // NOTIFICATIONS
    //================================================================================
    
    // Users can only manage their own notifications.
    match /notifications/{userId}/user_notifications/{notificationId} {
        allow read, write: if isOwner(userId);
    }
  }
}
